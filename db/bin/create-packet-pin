#!/usr/bin/env bash
set -eux

while [[ $# -gt 0 ]]; do
    case "$1" in
        --packet-id)
            PACKET_ID="$2"
            shift 2
            ;;
        *)
            echo "Invalid argument: $1"
            exit 1
            ;;
    esac
done

if [ -z "${PACKET_ID:-}" ]; then
    echo "Error: --packet-id argument is required."
    exit 1
fi


echo "Creating pin for packet id: $PACKET_ID"

if ! psql -U packituser -d packit \
    --single-transaction \
    -v ON_ERROR_STOP=on \
    -v "packet=$PACKET_ID" <<EOF
INSERT INTO "pin" (packet_id)
VALUES (:'packet');
EOF
then
    echo "Error: Failed to execute psql command for packet id: $PACKET_ID"
    exit 1
fi

# TODO: add instruction to PR reviewers to remind them to rebuild the db image before trying to use this script